<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<title>Blockade - Play</title>
		<link rel="stylesheet" href="css/bootstrap.css" title="dark">
		<script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha256-cCueBR6CsyA4/9szpPfrX3s49M9vUU5BgtiJj06wt/s=" crossorigin="anonymous"></script>
		<style>
			html, body {
				max-width: 100%;
				overflow-x: hidden;
			}
			td {
				width: 50px;
				height: 50px;
				text-align: center;
				padding: 1px;
			}
			div.cell {
				background-color: #333333;
				height: 48px;
			}
			.container {
				position: absolute;
				top: 50%;
				left: 50%;
				transform: translateX(-50%) translateY(-50%);
			}
			.block {
				margin: 2px;
				width: 46px;
				height: 46px;
			}
			.block-group {
				position: absolute;
			}
			.plate {
				margin: 17px;
				padding: 5px;
				width: 16px;
				height: 16px;
				position: absolute;
			}
			.directional-button-vertical {
				margin: 17px 13px;
				padding: 5px;
				width: 24px;
				height: 16px;
				position: absolute;
			}
			.directional-button-horizontal {
				margin: 13px 17px;
				padding: 5px;
				width: 16px;
				height: 24px;
				position: absolute;
			}
		</style>
	</head>
	<body style="font-family: Hasklig;">
		<nav id="menu" class="navbar navbar-default" style="width: 440px;position: absolute; left:-385px;">
			<div class="container-fluid" style="padding-right: 0px;">
				<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
					<ul class="nav navbar-nav">
						<li><a href="levelselect.html">Level Select</a></li>
						<li><a href="#" class="modal-button" data-toggle="modal" data-target="#helpModal">Help</a></li>
						<li><a href="#" id="restart">Restart</a></li>
						<li><a href="menu.html" id="exit">Exit</a></li>
						<li><a id="arrow" style="padding-right: 0px;">»</a></li>
					</ul>
				</div>
			</div>
		</nav>
		<nav id="panel" class="navbar navbar-default" style="position: absolute; left: 542px; bottom: 0px; margin: 0px; width:1000px;">
			<div class="container-fluid" style="padding-left: 0px;">
				<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-2" style="padding-left: 24px;">
					<ul class="nav navbar-nav">
						<li><a href="#" id="panel-arrow" style="padding-left: 0px;">»</a></li>
						<li><a>Turns: <span id="turns">0</span></a></li>
						<li><a>Time: <span id="time">5</span>s</a></li>
					</ul>
				</div>
			</div>
		</nav>
		<div class="container" id="game" align="center" style="display: inline-block; margin: 0px; padding: 0px;">
			<table id="table" style="margin: 0px;">
			</table>
		</div>
		<div id="helpModal" class="modal fade" role="dialog">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
						<h4 class="modal-title">Help</h4>
					</div>
					<div class="modal-body">
						<p>TODO</p>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
					</div>
				</div>
			</div>
		</div>
		<div id="winModal" class="modal fade" role="dialog">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
						<h4 class="modal-title">Level Complete!</h4>
					</div>
					<div class="modal-body">
						<p>TODO</p>
					</div>
					<div class="modal-footer">
						<button href="menu.html" type="button" class="btn btn-primary" data-dismiss="modal" id="continue">Continue</button>
					</div>
				</div>
			</div>
		</div>
	</body>
	<script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha256-cCueBR6CsyA4/9szpPfrX3s49M9vUU5BgtiJj06wt/s=" crossorigin="anonymous"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
	<script>
		const fs = require("fs");
		level = location.search.split("?")[1].split("&")[0].split('=')[1];
		custom = location.search.split("?")[1].split("&")[1].split('=')[1];
		if (custom == '0') {
			file = fs.readFileSync(`${__dirname}/data/levels/level${level}.json`, "utf8").replace(/(?:\r\n|\r|\n)/g, "").replace("  ", "");
			cont = "levelselect.html";
		} else if (custom != '2') {
			file = fs.readFileSync(`${__dirname}/data/levels/user/${level}.json`, "utf8").replace(/(?:\r\n|\r|\n)/g, "").replace("  ", "");
		} else {
			file = fs.readFileSync(`${__dirname}/data/levels/temp.json`, "utf8").replace(/(?:\r\n|\r|\n)/g, "").replace("  ", "");
			$("#exit").html("Back").attr("href", "editor.html?play=1");
			cont = "editor.html?play=1";
		}

		leveldata = JSON.parse(file);

		grid = []
		moves = 0
		$.fn.modal.prototype.constructor.Constructor.DEFAULTS.backdrop = 'static';

		for (var y = 0; y < leveldata.grid[1]; y++) {
			$("#table").append(`<tr id="row-${y}"></tr>`);
			for (var x = 0; x < leveldata.grid[0]; x++) {
				$(`#row-${y}`).append(`<td class="cell x-${x} y-${y}"></td>`);
			}
		}

		for (var x = 0; x < leveldata.grid[0]; x++) {
			grid.push([]);
			for (var y = 0; y < leveldata.grid[1]; y++) {
				grid[x].push([]);
			}
		}

		$("#game").css({"width": `${leveldata.grid[0] * 50}px`})

		leveldata.tiles.forEach(function (tile, index) {
			$(`td.x-${tile[0]}.y-${tile[1]}`).append(`<div class="cell x-${tile[0]} y-${tile[1]}"></div>`);
			grid[tile[0]][tile[1]].push("tile");
		});

		leveldata.plates.forEach(function (plate, index) {
			$("#game").append(`<a href="#" class="btn btn-warning disabled plate" style="left: ${plate[0] * 50}px; top: ${plate[1] * 50}px;"></a>`);
			grid[plate[0]][plate[1]].push("plate");
		});

		leveldata.blocks.forEach(function (block, index) {
			$("#game").append(`<span data-id="${index}" class="block-group" style="left: ${block[0] * 50}px; top: ${block[1] * 50}px;" id="block-${index}"><a href="#" class="btn btn-info disabled block"></a></span>`);
			grid[block[0]][block[1]].push("block");
		});

		$("#menu").on("mouseenter", function() {
			setTimeout(function() {$("#arrow").html('«')}, 100)
			$(this).animate({left:0}, 200);
		});
		$("#menu").on("mouseleave", function() {
			setTimeout(function() {$("#arrow").html('»')}, 100)
			$(this).animate({left:-385}, 200);
		});
		$("#panel-arrow").on("click", function() {
			setTimeout(function() {$("#panel-arrow").html(($("#panel-arrow").html() == '»')?'«':'»')}, 100)
			$("#panel").animate({left:($("#panel").css("left") == "542px")?742:542}, 200);
		});
		$("#continue").on("click", function() {
			window.location = cont;
		});
		$("#restart").on("click", function() {
			location = location.pathname + location.search;
		});
		$("#game").on("mouseenter", ".block-group", function() {
			id = $(this).data("id");
			$(this).addClass("mouseover");
			x = leveldata.blocks[id][0]; y = leveldata.blocks[id][1];
			var vert = [];
			var horz = [];
			for (var i = -1; i < 2; i += 2) {
				vert[(i < 0)?0:1] = {
					type: (grid[x][y+i] instanceof Array && grid[x][y+i].includes("tile") && (!grid[x][y+i].includes("block")))?"success":"default",
					disable: (grid[x][y+i] instanceof Array && grid[x][y+i].includes("tile") && (!grid[x][y+i].includes("block")))?"":"disabled ",
				}
			}
			for (var j = -1; j < 2; j += 2) {
				horz[(j < 0)?0:1] = {
					type: (grid[x+j] instanceof Array && grid[x+j][y] instanceof Array && grid[x+j][y].includes("tile") && (!grid[x+j][y].includes("block")))?"success":"default",
					disable: (grid[x+j] instanceof Array && grid[x+j][y] instanceof Array && grid[x+j][y].includes("tile") && (!grid[x+j][y].includes("block")))?"":"disabled ",
				}
			}
			$(this).append(`<span class="button-group"><a href="#" class="btn btn-${vert[0].type} directional-button directional-button-vertical" ${vert[0].disable}style="left: 0px; top: -20px;" id="up" data-id="${id}"></a>
<a href="#" class="btn btn-${vert[1].type} directional-button directional-button-vertical" ${vert[1].disable}style="left: 0px; top: 20px;" id="down" data-id="${id}"></a>
<a href="#" class="btn btn-${horz[0].type} directional-button directional-button-horizontal" ${horz[0].disable}style="left: -20px; top: 0px;" id="left" data-id="${id}"></a>
<a href="#" class="btn btn-${horz[1].type} directional-button directional-button-horizontal" ${horz[1].disable}style="left: 20px; top: 0px;" id="right" data-id="${id}"></a></span>`)
			//$(".block-group").animate({left: "200px"})
		});
		$("#game").on("mouseleave", ".block-group", function() {
			$(this).removeClass("mouseover");
			$("span:last-child", $(".block-group")).remove();
		});
		$("#game").on("click", ".directional-button", function() {
			if (!$(this).attr("disabled")) {
				move();
				id = $(this).data("id");
				direction = $(this).attr("id");
				directions = {"up": [0, -1], "down": [0, 1], "left": [-1, 0], "right": [1, 0]};
				dir = {x: directions[direction][0], y: directions[direction][1]};
				block = {x: leveldata.blocks[id][0], y: leveldata.blocks[id][1]};
				count = 0;
				while (grid[block.x + dir.x] instanceof Array && grid[block.x + dir.x][block.y + dir.y] instanceof Array && grid[block.x + dir.x][block.y + dir.y].includes("tile") && (!grid[block.x + dir.x][block.y + dir.y].includes("block"))) {
					for(var i = 0; i < grid[block.x][block.y].length; i++) {
						if(grid[block.x][block.y][i] == "block") {
							grid[block.x][block.y].splice(i, 1);
						}
					}
					block.x += dir.x; block.y += dir.y;
					leveldata.blocks[id] = [block.x, block.y];
					grid[block.x][block.y].push("block");
				}
				$("span:last-child", $(".block-group")).remove();
				$(`.block-group#block-${id}`).animate({left: `${block.x * 50}px`, top: `${block.y * 50}px`}, 400, "swing", checkForWin);
			}
		});
		function move() {
			moves++;
			$("#turns").html(moves);
		}
		function checkForWin() {
			pressed = []
			leveldata.plates.forEach(function (plate, index) {
				pressing = []
				leveldata.blocks.forEach(function (block, index) {
					if (plate[0] == block[0] && plate[1] == block[1]) {
						pressing.push(true);
					} else {
						pressing.push(false);
					}
				});
				if (pressing.includes(true)) {
					pressed.push(true);
				} else {
					pressed.push(false);
				}
			});
			if (!pressed.includes(false)) {
				win()
			}
		}
		function win() {
			clearInterval(clock);
			setTimeout(function () {
				$("#winModal").modal("toggle")
			}, 200);
		}
		time = 0;
		clock = setInterval(function() {time += 1; $("#time").html(Math.floor(time/250))}, 1);
		$(document).on("keydown", function(event) {
			if ($(".mouseover").length == 1) {
				if (event.key == "w") {
					$("#up").trigger("click");
				} else if (event.key == "a") {
					$("#left").trigger("click");
				} else if (event.key == "s") {
					$("#down").trigger("click");
				} else if (event.key == "d") {
					$("#right").trigger("click");
				}
			}
		});
	</script>
	<script src="js/blockade.js"></script>
</html>
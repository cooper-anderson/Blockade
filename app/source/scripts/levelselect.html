<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<title>Blockade - Level Select</title>
		<link rel="stylesheet" href="css/bootstrap.css" title="dark">
		<script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha256-cCueBR6CsyA4/9szpPfrX3s49M9vUU5BgtiJj06wt/s=" crossorigin="anonymous"></script>
		<style>
			[disabled] {
				pointer-events: none;
			}
			td {
				padding: 5px;
			}
			.level-button {
				padding: 18px 0px;
			}
		</style>
	</head>
	<body style="font-family: Hasklig; -webkit-user-select: none; cursor: default;">
		<div class="container" align="center">
			<br><br><br>
			<a href="#" id="leftArrow" data-id="-1" class="btn btn-info move"><-</a>
			<a href="#" id="title" class="btn btn-info disabled" style="width: 290px; cursor: default; opacity: 1.0;">Page </a>
			<a href="#" id="rightArrow" data-id="1" class="btn btn-info move">-></a>
			<br><br>
			<div class="panel panel-primary" style="position: absolute; left: 8px; right: 558px; top: 134px; height: 290px;">
				<div class="panel-heading">
					<h3 class="panel-title">Local Score</h3>
				</div>
				<div class="panel-body" style="padding-top: 8px;">
					<span style="float: left;">Level: </span><span class="local level" style="float: right;"></span><br><br>
					<span style="float: left;">Time: </span><span class="local time" style="float: right;"></span><br><br>
					<span style="float: left;">Moves: </span><span class="local moves" style="float: right;"></span><br><br>
					<span style="float: left;">Accuracy: </span><span class="local accuracy" style="float: right;"></span><br><br>
					<span style="float: left;">Score: </span><span class="local score" style="float: right;"></span><br><br>
					<span style="float: left;">Rank: </span><span class="local rank" style="float: right;"></span><br><br>
				</div>
			</div>

			<table id="table" style="margin-right: 7px;"></table>
			<br>
			<a href="menu.html" class="btn btn-default" style="width: 140px;">Back</a>
			<a href="#" class="btn btn-info disabled" id="play-button" style="width: 140px;" data-id="">Play</a>

			<div class="panel panel-primary" style="position: absolute; left: 550px; right: 8px; top: 134px; height: 290px;">
				<div class="panel-heading">
					<h3 class="panel-title">Global Score</h3>
				</div>
				<div class="panel-body" style="padding-top: 8px;">
					<span style="float: left;">Level: </span><span class="global level" style="float: right;"></span><br><br>
					<span style="float: left;">Time: </span><span class="global time" style="float: right;"></span><br><br>
					<span style="float: left;">Moves: </span><span class="global moves" style="float: right;"></span><br><br>
					<span style="float: left;">Accuracy: </span><span class="global accuracy" style="float: right;"></span><br><br>
					<span style="float: left;">Score: </span><span class="global score" style="float: right;"></span><br><br>
					<span style="float: left;">Rank: </span><span class="global rank" style="float: right;"></span><br><br>
				</div>
			</div>
		</div>
	</body>
	<script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha256-cCueBR6CsyA4/9szpPfrX3s49M9vUU5BgtiJj06wt/s=" crossorigin="anonymous"></script>
	<script>
		const fs = require("fs");

		levels = {};
		fs.readdirSync(`${__dirname}/../default-levels/`).filter(function(levelName) {
			return levelName.startsWith("level") && levelName.endsWith(".json") && /(?!(?!0$)0)^[0-9]+$/.test(levelName.slice(5, -5));
		}).forEach(function(levelName) {
			level = Number(levelName.slice(5, -5));
			color = JSON.parse(fs.readFileSync(`${__dirname}/../default-levels/level${level}.json`)).info["icon-color"];
			color = ["default", "primary", "success", "info", "warning", "danger"].includes(color) ? color : "primary";
			levels[level] = {color: color};
		});

		const size = [4, 4];
		const pages = Math.min(Math.ceil(Math.max.apply(null, Object.keys(levels).map(function(levelNum) {return Number(levelNum);}).concat([1])) / (size[0] * size[1])), 4096);

		var level = undefined;
		var page = 1;

		function init() {
			$(".btn").attr("draggable", "false");
			update();
		}
		function update() {
			$("#table").empty();
			$("#table").data("id", page);
			$("#title").html(`Page ${page}`);
			if (page + $("#leftArrow").data("id") < 1) $("#leftArrow").addClass("disabled");
			else $("#leftArrow").removeClass("disabled");
			if (page + $("#rightArrow").data("id") > pages) $("#rightArrow").addClass("disabled");
			else $("#rightArrow").removeClass("disabled");
			for (var y = 0; y < size[1]; y++) {
				$("#table").append(`<tr id="row-${y + 1}"></tr>`);
				for (var x = 0; x < size[0]; x++) {
					var level = size[0] * size[1] * (page - 1) + (y * size[0] + x + 1);
					var exists = Object.keys(levels).includes(String(level));
					var color = exists ? levels[level].color : "default";
					$("#row-" + (y + 1)).append(`<td class="row-${y + 1} col-${x + 1}"></td>`);
					$(`.row-${y + 1}.col-${x + 1}`).append(`<a href="#" id="${level}" class="btn btn-${color} btn-lg btn-block level-button ${exists ? "" : "disabled"}" style="width: 65px;">${level}</a>`);
				}
			}
			$(".level-button").attr("draggable", "false");
			highlight();
		}
		function highlight() {
			$('.level-button').removeClass("active");
			if (level !== undefined) $(`.level-button#${level}`).addClass("active");
		}
		$(".btn").on("mouseup mouseleave", function() {
			$(this).blur();
		});
		$("#table").on("mouseup mouseleave", ".level-button", function() {
			$(this).blur();
		});
		$(".move").on("click", function() {
			if (!$(this).hasClass("disabled")) {
				page += $(this).data("id");
			}
			update();
		});
		$("#table").on("click", ".level-button", function() {
			if (level != $(this).attr("id")) {
				level = $(this).attr("id");
				$(".local.level").html(level);
				$(".global.level").html(level);
				if (Object.keys(levels).includes(String(level))) $("#play-button").removeClass("disabled").data("id", level);
				else $("#play-button").addClass("disabled").data("id", 0);
			} else {
				if (!$("#play-button").hasClass("disabled")) {
					window.location = `play.html?leveldata=${$("#play-button").data("id")}&custom=0`
				}
			}
			highlight();
		});
		$("#play-button").on("click", function() {
			if (!$(this).hasClass("disabled")) {
				window.location = `play.html?leveldata=${$(this).data("id")}&custom=0`
			}
		});
		init();
	</script>
</html>